<!DOCTYPE html>
<html lang="en">
<head>
    <!--
    //--------------------------------------------------------------------------------
    //                                  HEAD & METADATA
    //--------------------------------------------------------------------------------
    -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASLAN</title>
    <link rel="icon" href="{{ url_for('static', filename='images/bloglogo2.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
<div class="background-image"></div>
<div class="container">
    <!--
    //--------------------------------------------------------------------------------
    //                                  SIDEBAR & NAV
    //--------------------------------------------------------------------------------
    -->
    <nav class="sidebar">
        <div class="logo">
            <a href="/"><img src="{{ url_for('static', filename='images/bloglogo2.png') }}" alt="Blog Logo"></a>
        </div>
        {% if session.username %}
        <div class="welcome-message">
            Welcome, {{ session.username }}
        </div>
        {% endif %}
        <ul class="menu">
            <li class="nav-item"><a href="/" class="{% if current_route == 'index' %}active-link{% endif %}">Feed</a></li>
            <li class="nav-item"><a href="/images" class="{% if current_route == 'images' %}active-link{% endif %}">Images</a></li>
            <li class="nav-item"><a href="/files" class="{% if current_route == 'files' %}active-link{% endif %}">Files</a></li>
            <li class="nav-item"><a href="#" id="new-post-link">New</a></li>        <li class="nav-item"><a href="#" id="search-link">Search</a></li>
        <li class="nav-item"><a href="/logout">Logout</a></li>
    </ul>
</nav>

<a href="#" id="new-post-bottom-right-link">+</a>

    <!--
    //--------------------------------------------------------------------------------
    //                                  MAIN CONTENT
    //--------------------------------------------------------------------------------
    -->
    <main>
        <!--
        //--------------------------------------------------------------------------------
        //                               NEW POST POPUP
        //--------------------------------------------------------------------------------
        -->
        <div id="new-post-popup" class="post-form-popup">
            <div class="post-form-content">
                <span class="close-button" id="close-new-post">&times;</span>
                <section class="post-form">
                    <form method="POST" action="/" autocomplete="off" id="post-form-container">
                        <input type="text" id="title-input" name="title" placeholder="Title" required aria-label="Post Title">
                        <textarea name="content" id="content-textarea" placeholder="Content" rows="3" required aria-label="Post Content"></textarea>

                        <!-- Upload File Section (moved inside popup) -->
                        <section class="dropzone-section">
                            <h2>Upload Files</h2>
                            <div id="drop-zone">
                                <p>Drag & Drop</p>
                                <input type="file" id="file-input" multiple style="display: none;">
                            </div>
                            <div id="upload-progress"></div>
                        </section>

                        <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
                        <button type="button" id="insert-image-button">Insert Image</button>
                        <button type="submit">Post</button>
                    </form>
                </section>
            </div>
        </div>

        <!--
        //--------------------------------------------------------------------------------
        //                               EDIT POST POPUP
        //--------------------------------------------------------------------------------
        -->
        <div id="edit-post-popup" class="post-form-popup">
            <div class="post-form-content">
                <span class="close-button" id="close-edit-post">&times;</span>
                <section class="post-form">
                    <form method="POST" action="" autocomplete="off" id="edit-form-container">
                        <input type="hidden" id="edit-post-id" name="post_id">
                        <input type="text" id="edit-title-input" name="title" placeholder="Title" required aria-label="Post Title">
                        <textarea name="content" id="edit-content-textarea" placeholder="Content" rows="3" required aria-label="Post Content"></textarea>
                        <button type="submit">Update Post</button>
                    </form>
                </section>
            </div>
        </div>

        <!--
        //--------------------------------------------------------------------------------
        //                                 SEARCH POPUP
        //--------------------------------------------------------------------------------
        -->
        <div id="search-popup" class="post-form-popup">
            <div class="search-popup-content">
                <span class="close-button" id="close-search">&times;</span>
                <section class="search-form-section">
                    <form method="get" action="/" autocomplete="off" class="search-form">
                        <input type="text" name="q" placeholder="Search" value="{{ query }}" aria-label="Search posts">
                        <button type="submit">Search</button>
                    </form>
                </section>
            </div>
        </div>

        <!--
        //--------------------------------------------------------------------------------
        //                                DISPLAY POSTS
        //--------------------------------------------------------------------------------
        -->
        <section class="posts">
            {% if posts %}
                {% for post in posts %}
                    <div class="post">
                        <h2>{{ post.title }}</h2>
                        <div class="post-content">{{ post.content | nl2p | safe }}</div>
                        <a href="/edit/{{ post.id }}" class="edit-post-link">Edit</a>
                        <a href="/delete/{{ post.id }}" class="delete-post-link" onclick="return confirm('Are you sure you want to delete this post?')">X</a>
                    </div>
                {% endfor %}
            {% else %}
                <p>No posts found.</p>
            {% endif %}
        </section>

        <!--
        //--------------------------------------------------------------------------------
        //                                 IMAGE POPUP
        //--------------------------------------------------------------------------------
        -->
        <div id="image-popup" class="post-form-popup">
            <span class="close-button" id="close-image-popup">&times;</span>
            <img class="image-popup-content" id="popup-image">
        </div>
    </main>
</div>

<!--
//--------------------------------------------------------------------------------
//                                     SCRIPTS
//--------------------------------------------------------------------------------
-->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        /*
        * -------------------
        *  POPUP VISIBILITY
        * -------------------
        */
        const newPostLink = document.getElementById('new-post-link');
        const newPostPopup = document.getElementById('new-post-popup');
        const closeNewPostButton = document.getElementById('close-new-post');

        const searchLink = document.getElementById('search-link');
        const searchPopup = document.getElementById('search-popup');
        const closeSearchButton = document.getElementById('close-search');

        const newPostBottomRightLink = document.getElementById('new-post-bottom-right-link');

        newPostLink.addEventListener('click', (event) => {
            event.preventDefault();
            newPostPopup.classList.add('visible');
        });

        newPostBottomRightLink.addEventListener('click', (event) => {
            event.preventDefault();
            newPostPopup.classList.add('visible');
        });

        closeNewPostButton.addEventListener('click', () => {
            newPostPopup.classList.remove('visible');
        });

        searchLink.addEventListener('click', (event) => {
            event.preventDefault();
            searchPopup.classList.add('visible');
        });

        closeSearchButton.addEventListener('click', () => {
            searchPopup.classList.remove('visible');
        });

        window.addEventListener('click', (event) => {
            if (event.target == newPostPopup) {
                newPostPopup.classList.remove('visible');
            } else if (event.target == searchPopup) {
                searchPopup.classList.remove('visible');
            } else if (event.target == editPostPopup) {
                editPostPopup.classList.remove('visible');
            }
        });

        /*
        * -------------------
        *  EDIT POST POPUP
        * -------------------
        */
        const editPostPopup = document.getElementById('edit-post-popup');
        const closeEditPostButton = document.getElementById('close-edit-post');
        const editForm = document.getElementById('edit-form-container');
        const editPostId = document.getElementById('edit-post-id');
        const editTitleInput = document.getElementById('edit-title-input');
        const editContentTextarea = document.getElementById('edit-content-textarea');

        document.querySelectorAll('.edit-post-link').forEach(link => {
            link.addEventListener('click', async (event) => {
                event.preventDefault();
                const postId = link.getAttribute('href').split('/').pop();
                
                const response = await fetch(`/edit/${postId}`);
                const post = await response.json();

                editPostId.value = post.id;
                editTitleInput.value = post.title;
                editContentTextarea.value = post.content;
                editForm.action = `/edit/${post.id}`;

                editPostPopup.classList.add('visible');
            });
        });

        closeEditPostButton.addEventListener('click', () => {
            editPostPopup.classList.remove('visible');
        });

        /*
        * -------------------
        *  POST ANIMATIONS
        * -------------------
        */
        const posts = document.querySelectorAll('.post');

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                }
            });
        }, {
            threshold: 0.1
        });

        posts.forEach(post => {
            observer.observe(post);
        });

        /*
        * -------------------
        *  IMAGE UPLOADS
        * -------------------
        */
        const contentTextarea = document.getElementById('content-textarea');
        const insertImageButton = document.getElementById('insert-image-button');
        const imageUploadInput = document.getElementById('image-upload-input');

        insertImageButton.addEventListener('click', () => {
            imageUploadInput.click();
        });

        imageUploadInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/upload-image', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.image_url) {
                    const imageUrl = data.image_url;
                    const imageTag = `<img src="${imageUrl}" alt="${file.name}" class="post-image">`;
                    
                    const start = contentTextarea.selectionStart;
                    const end = contentTextarea.selectionEnd;
                    const text = contentTextarea.value;
                    const newText = text.substring(0, start) + imageTag + text.substring(end);
                    contentTextarea.value = newText;

                    // Reset the input so the same file can be selected again
                    imageUploadInput.value = '';
                }
            } catch (error) {
                console.error('Error uploading image:', error);
            }
        });

        /*
        * -------------------
        *  FILE DROPZONE
        * -------------------
        */
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const uploadProgress = document.getElementById('upload-progress');
        let droppedFile = null; // Variable to store the dropped file

        if (dropZone) { // Ensure dropZone exists before adding listeners
            dropZone.addEventListener('click', () => fileInput.click());

            dropZone.addEventListener('dragenter', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                handleFiles(files);
            });

            fileInput.addEventListener('change', (e) => {
                const files = e.target.files;
                handleFiles(files);
            });

            async function handleFiles(files) {
                if (files.length > 0) {
                    const file = files[0];
                    const titleInput = document.getElementById('title-input');
                    const contentTextarea = document.getElementById('content-textarea');
                    
                    titleInput.value = file.name;

                    const formData = new FormData();
                    formData.append('file', file);

                    try {
                        const response = await fetch('/upload-file', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();
                        if (data.file_url) {
                            const permanentFileUrl = data.file_url;
                            if (data.is_image) {
                                contentTextarea.value = `Image ready for upload: ${file.name}\n\n<img src="${permanentFileUrl}" alt="${file.name}" class="post-image-preview">`;
                            } else {
                                contentTextarea.value = `File ready for upload: ${file.name}\n\n<a href="${permanentFileUrl}">${file.name}</a>`;
                            }
                        } else {
                            console.error('Error uploading file: No file_url received');
                        }
                    } catch (error) {
                        console.error('Error uploading file:', error);
                    }
                }
            }
        }

        const postForm = document.getElementById('post-form-container');
        postForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const formData = new FormData(postForm);
            // No need to append droppedFile here, as it's already uploaded in handleFiles

            const response = await fetch('/', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                window.location.reload();
            } else {
                console.error('Error creating post');
            }
        });

        /*
        * -------------------
        *  NAV ANIMATIONS
        * -------------------
        */
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach((item, index) => {
            item.style.opacity = 0;
            item.style.transform = 'translateY(10px)';
            setTimeout(() => {
                item.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
                item.style.opacity = 1;
                item.style.transform = 'translateY(0)';
            }, index * 100); // Stagger by 100ms
        });

        /*
        * -------------------
        *  IMAGE POPUP
        * -------------------
        */
        const imagePopup = document.getElementById('image-popup');
        const popupImage = document.getElementById('popup-image');
        const closeImagePopup = document.getElementById('close-image-popup');

        document.querySelectorAll('.post-content').forEach(content => {
            content.addEventListener('click', (event) => {
                if (event.target.classList.contains('post-image')) {
                    imagePopup.classList.add('visible');
                    popupImage.src = event.target.src;
                }
            });
        });

        closeImagePopup.addEventListener('click', () => {
            imagePopup.classList.remove('visible');
        });

        imagePopup.addEventListener('click', (event) => {
            if (event.target === imagePopup) {
                imagePopup.classList.remove('visible');
            }
        });
    });
</script>

</body>
</html>